# Agent Validation Workflow
# Validates agent definitions, skills, and VS Code configuration
# Triggered on changes to agents, skills, or VS Code settings

name: Agent Validation

on:
  push:
    branches: [main, feature/*]
    paths:
      - ".github/agents/**"
      - ".github/skills/**"
      - ".github/instructions/**"
      - ".devcontainer/devcontainer.json"
      - ".vscode/mcp.json"
      - ".vscode/extensions.json"
      - "scripts/validate-agent-frontmatter.mjs"
      - "scripts/validate-skills-format.mjs"
      - "scripts/validate-mcp-config.mjs"
      - "scripts/validate-vscode-config.mjs"
      - "scripts/validate-instruction-frontmatter.mjs"
  pull_request:
    branches: [main]
    paths:
      - ".github/agents/**"
      - ".github/skills/**"
      - ".github/instructions/**"
      - ".devcontainer/devcontainer.json"
      - ".vscode/mcp.json"
      - ".vscode/extensions.json"
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  validate:
    name: Validate Agents & Skills
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Run VS Code 1.109 validation suite
        run: npm run test:1109

      - name: Validate MCP config
        run: npm run lint:mcp-config

      - name: Validate instruction file frontmatter
        run: npm run lint:instruction-frontmatter

      - name: Validate handoff references
        run: |
          echo "üîó Validating agent handoff references..."

          # Extract all handoff agent references (one per line, preserving multi-word names)
          grep -rh "agent:" .github/agents/*.agent.md 2>/dev/null | \
            grep -v "^---" | \
            sed 's/.*agent: *//' | \
            tr -d '"' | \
            sort -u > /tmp/handoffs.txt

          # Extract all agent names (one per line)
          grep -rh "^name:" .github/agents/*.agent.md 2>/dev/null | \
            sed 's/name: *//' | \
            tr -d '"' | \
            sort -u > /tmp/agents.txt

          # VS Code built-in agent names (not custom agents, but valid handoff targets)
          BUILTIN_AGENTS="agent"

          # Check each handoff reference exists
          ERRORS=0
          while IFS= read -r handoff; do
            [ -z "$handoff" ] && continue
            # Skip known VS Code built-in agents
            if echo "$BUILTIN_AGENTS" | grep -qiw "$handoff"; then
              continue
            fi
            if ! grep -qi "^${handoff}$" /tmp/agents.txt; then
              echo "‚ùå Invalid handoff reference: $handoff"
              ERRORS=$((ERRORS + 1))
            fi
          done < /tmp/handoffs.txt

          if [ $ERRORS -gt 0 ]; then
            echo "‚ùå Found $ERRORS invalid handoff reference(s)"
            exit 1
          else
            echo "‚úÖ All handoff references are valid"
          fi

      - name: Report self-handoffs
        run: |
          echo "üîÑ Checking self-handoffs (intentional loop-back actions)..."
          SELF_LOOPS=0
          for file in .github/agents/*.agent.md; do
            AGENT_NAME=$(grep -m1 "^name:" "$file" | sed 's/name: *//' | tr -d '"')
            COUNT=$(grep -c "agent: $AGENT_NAME" "$file" 2>/dev/null || echo "0")
            if [ "$COUNT" -gt 0 ]; then
              echo "‚ÑπÔ∏è  $AGENT_NAME: $COUNT self-handoff(s)"
              SELF_LOOPS=$((SELF_LOOPS + COUNT))
            fi
          done
          echo "‚úÖ Total: $SELF_LOOPS intentional self-handoffs"
